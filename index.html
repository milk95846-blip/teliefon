<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Chat</title>
    <!-- Подключаем скрипт Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Подключаем API Jitsi -->
    <script src='https://meet.jit.si/external_api.js'></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background-color: #000; }
        #meet { width: 100%; height: 100%; }
        /* Центрируем сообщение, если что-то пойдет не так */
        .loading { color: white; display: flex; justify-content: center; align-items: center; height: 100%; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="meet"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); // Разворачиваем на весь экран

        // Функция для получения параметров из URL
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Получаем ID комнаты из ссылки, которую прислал бот
        const roomName = getQueryParam('room');

        if (!roomName) {
            document.getElementById('meet').innerHTML = '<div class="loading">Ошибка: Комната не найдена</div>';
        } else {
            const domain = 'meet.jit.si';
            const options = {
                roomName: roomName,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#meet'),
                lang: 'be', // Белорусский интерфейс (если Jitsi поддерживает) или 'ru'
                configOverwrite: {
                    startWithAudioMuted: false,
                    startWithVideoMuted: true, // Начинать без видео
                    prejoinPageEnabled: false // Пропустить страницу "Я готов"
                },
                interfaceConfigOverwrite: {
                    MOBILE_APP_PROMO: false, // Отключить рекламу приложения
                    TOOLBAR_BUTTONS: [
                        'microphone', 'camera', 'closedcaptions', 'desktop', 'fullscreen',
                        'fodeviceselection', 'hangup', 'profile', 'chat', 'recording',
                        'livestreaming', 'etherpad', 'sharedvideo', 'settings', 'raisehand',
                        'videoquality', 'filmstrip', 'invite', 'feedback', 'stats', 'shortcuts',
                        'tileview', 'videobackgroundblur', 'download', 'help', 'mute-everyone',
                        'security'
                    ]
                }
            };

            const api = new JitsiMeetExternalAPI(domain, options);

            // Когда пользователь нажимает "Завершить звонок" -> закрываем Mini App
            api.addEventListener('videoConferenceLeft', () => {
                tg.close();
            });
            
            // Если человека кикнули или звонок оборвался
            api.addEventListener('readyToClose', () => {
                tg.close();
            });
        }
    </script>
</body>
</html>